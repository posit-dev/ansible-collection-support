---
# tasks/common_api_call.yml - Common API call logic with error handling and retries
# This task file expects the following variables to be set:
#   - api_endpoint_url: The full URL to call
#   - api_endpoint_name: Name of the endpoint for logging
#   - api_response_var: Variable name to store the response

- name: Display API request details
  ansible.builtin.debug:
    msg:
      - "Calling {{ api_endpoint_name }} endpoint"
      - "URL: {{ api_endpoint_url }}"
      - "Project ID: {{ semaphore_project_id | default('N/A') }}"
      - "Resource ID: {{ semaphore_resource_id | default('all', true) }}"
      - "Query params: {{ semaphore_api_query_params }}"
  when: semaphore_api_debug | bool

- name: Build query string from parameters
  ansible.builtin.set_fact:
    query_string: "{{ semaphore_api_query_params | urlencode }}"
  when: semaphore_api_query_params | length > 0

- name: Set final API URL with query parameters
  ansible.builtin.set_fact:
    final_api_url: "{{ api_endpoint_url }}{% if semaphore_api_query_params | length > 0 %}?{{ query_string }}{% endif %}"

- name: Display final URL
  ansible.builtin.debug:
    msg: "Final API URL: {{ final_api_url }}"
  when: semaphore_api_verbose_debug | bool

- name: Make API call with token authentication
  ansible.builtin.uri:
    url: "{{ final_api_url }}"
    method: GET
    headers:
      Authorization: "Bearer {{ semaphore_api_token }}"
      Content-Type: "application/json"
      Accept: "application/json"
    validate_certs: "{{ semaphore_api_validate_certs }}"
    timeout: "{{ semaphore_api_timeout }}"
    follow_redirects: "{{ semaphore_api_follow_redirects }}"
    return_content: "{{ semaphore_api_return_content }}"
    status_code: "{{ semaphore_api_expected_status_codes | default([semaphore_api_status_code]) }}"
  register: _api_response_token
  until: _api_response_token.status | default(-1) in (semaphore_api_expected_status_codes | default([semaphore_api_status_code]))
  retries: "{{ semaphore_api_retries }}"
  delay: "{{ semaphore_api_retry_delay }}"
  when: semaphore_api_token is defined and semaphore_api_token != ""
  failed_when: false

- name: Make API call with basic authentication
  ansible.builtin.uri:
    url: "{{ final_api_url }}"
    method: GET
    user: "{{ semaphore_api_user }}"
    password: "{{ semaphore_api_password }}"
    force_basic_auth: true
    headers:
      Content-Type: "application/json"
      Accept: "application/json"
    validate_certs: "{{ semaphore_api_validate_certs }}"
    timeout: "{{ semaphore_api_timeout }}"
    follow_redirects: "{{ semaphore_api_follow_redirects }}"
    return_content: "{{ semaphore_api_return_content }}"
    status_code: "{{ semaphore_api_expected_status_codes | default([semaphore_api_status_code]) }}"
  register: _api_response_basic
  until: _api_response_basic.status | default(-1) in (semaphore_api_expected_status_codes | default([semaphore_api_status_code]))
  retries: "{{ semaphore_api_retries }}"
  delay: "{{ semaphore_api_retry_delay }}"
  when: semaphore_api_token is not defined or semaphore_api_token == ""
  failed_when: false

- name: Set unified API response
  ansible.builtin.set_fact:
    api_response: "{{ _api_response_token if (_api_response_token.status is defined) else _api_response_basic }}"

- name: Check if API response is valid
  ansible.builtin.set_fact:
    _api_response_valid: "{{ api_response is defined and api_response is mapping and 'status' in api_response }}"
    _api_call_failed: "{{ api_response.failed | default(false) }}"
    _api_call_msg: "{{ api_response.msg | default('No error message') }}"
    _api_status_code: "{{ api_response.status | default(-1) }}"

- name: Get human-readable error message for status code
  ansible.builtin.set_fact:
    _status_message: "{{ semaphore_http_status_messages[_api_status_code | int] | default('Unknown error') }}"
  when:
    - _api_response_valid | bool
    - _api_status_code | int != semaphore_api_status_code | int

- name: Check if API call was successful
  ansible.builtin.assert:
    that:
      - _api_response_valid | bool
      - not (_api_call_failed | bool)
      - _api_status_code | int in (semaphore_api_expected_status_codes | default([semaphore_api_status_code]))
    fail_msg: |
      API call failed for {{ api_endpoint_name }} endpoint.

      {% if not (_api_response_valid | bool) %}
      Error: API call did not return a valid response
      Message: {{ _api_call_msg }}
      URL: {{ final_api_url }}

      Troubleshooting:
        - Check that the Semaphore server is running and reachable
        - Verify the API URL is correct: {{ semaphore_api_base_url }}
        - Check network connectivity and firewall rules
      {% else %}
      Status Code: {{ _api_status_code }}
      Error: {{ _status_message | default('Unknown error') }}
      URL: {{ final_api_url }}

      {% if _api_status_code | int == 401 %}
      Troubleshooting: Check your API token or username/password credentials.
      {% elif _api_status_code | int == 403 %}
      Troubleshooting: Verify the user has permission to access this project/resource.
      {% elif _api_status_code | int == 404 %}
      Troubleshooting: Check that project_id={{ semaphore_project_id | default('N/A') }} and resource_id={{ semaphore_resource_id | default('N/A') }} exist.
      {% elif _api_status_code | int == 429 %}
      Troubleshooting: Rate limit hit. Increase semaphore_api_retry_delay or reduce request frequency.
      {% elif _api_status_code | int >= 500 %}
      Troubleshooting: This is a server-side error. Check Semaphore server logs.
      {% endif %}

      {% if api_response.json is defined and api_response.json.error is defined %}
      API Error Details: {{ api_response.json.error }}
      {% elif api_response.json is defined and api_response.json.message is defined %}
      API Message: {{ api_response.json.message }}
      {% endif %}

      Raw Response: {{ _api_call_msg }}
      {% endif %}
    success_msg: "Successfully retrieved data from {{ api_endpoint_name }} endpoint (HTTP {{ _api_status_code }})"

- name: Validate response is JSON
  ansible.builtin.assert:
    that:
      - api_response.json is defined
    fail_msg: |
      API response is not valid JSON for {{ api_endpoint_name }} endpoint.
      Content-Type received: {{ api_response.content_type | default('unknown') }}
      Response body (truncated): {{ api_response.content[:500] | default('empty') }}...
    success_msg: "Response is valid JSON"
  when:
    - semaphore_api_validate_json | default(true)
    - api_expects_json | default(true) | bool

- name: Display response summary
  ansible.builtin.debug:
    msg:
      - "Successfully retrieved data from {{ api_endpoint_name }}"
      - "HTTP Status: {{ _api_status_code }}"
      - "Response type: {{ api_response.json | type_debug if (api_expects_json | default(true) | bool) else 'plain text' }}"
      - "Response size: {% if (api_expects_json | default(true) | bool) and api_response.json is iterable and api_response.json is not string and api_response.json is not mapping %}{{ api_response.json | length }} items{% elif not (api_expects_json | default(true) | bool) %}{{ api_response.content | length }} chars{% else %}1 item{% endif %}"
      - "Response time: {{ api_response.elapsed | default('N/A') }} seconds"
  when: semaphore_api_debug | bool

- name: Display full response
  ansible.builtin.debug:
    var: "{{ 'api_response.json' if (api_expects_json | default(true) | bool) else 'api_response.content' }}"
  when: semaphore_api_verbose_debug | bool

- name: Set response fact (JSON)
  ansible.builtin.set_fact:
    "{{ api_response_var }}": "{{ api_response.json }}"
  when: api_expects_json | default(true) | bool

- name: Set response fact (plain text)
  ansible.builtin.set_fact:
    "{{ api_response_var }}": "{{ api_response.content }}"
  when: not (api_expects_json | default(true) | bool)

- name: Set response metadata fact
  ansible.builtin.set_fact:
    semaphore_api_last_response:
      status: "{{ _api_status_code | int }}"
      elapsed: "{{ api_response.elapsed | default(0) | int }}"
      url: "{{ final_api_url }}"
      endpoint: "{{ api_endpoint_name }}"
      content_type: "{{ api_response.content_type | default('application/json') }}"
  when: semaphore_api_store_metadata | default(true)
