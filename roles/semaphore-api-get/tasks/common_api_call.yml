---
# tasks/common_api_call.yml - Common API call logic with error handling and retries
# This task file expects the following variables to be set:
#   - api_endpoint_url: The full URL to call
#   - api_endpoint_name: Name of the endpoint for logging
#   - api_response_var: Variable name to store the response

- name: Display API request details
  ansible.builtin.debug:
    msg:
      - "Calling {{ api_endpoint_name }} endpoint"
      - "URL: {{ api_endpoint_url }}"
      - "Project ID: {{ semaphore_project_id }}"
      - "Resource ID: {{ semaphore_resource_id | default('all', true) }}"
      - "Query params: {{ semaphore_api_query_params }}"
  when: semaphore_api_debug | bool

- name: Build query string from parameters
  ansible.builtin.set_fact:
    query_string: "{{ semaphore_api_query_params | urlencode }}"
  when: semaphore_api_query_params | length > 0

- name: Set final API URL with query parameters
  ansible.builtin.set_fact:
    final_api_url: "{{ api_endpoint_url }}{% if semaphore_api_query_params | length > 0 %}?{{ query_string }}{% endif %}"

- name: Display final URL
  ansible.builtin.debug:
    msg: "Final API URL: {{ final_api_url }}"
  when: semaphore_api_verbose_debug | bool

- name: Make API call with token authentication
  ansible.builtin.uri:
    url: "{{ final_api_url }}"
    method: GET
    headers:
      Authorization: "Bearer {{ semaphore_api_token }}"
      Content-Type: "application/json"
    validate_certs: "{{ semaphore_api_validate_certs }}"
    timeout: "{{ semaphore_api_timeout }}"
    follow_redirects: "{{ semaphore_api_follow_redirects }}"
    return_content: "{{ semaphore_api_return_content }}"
    status_code: "{{ semaphore_api_status_code }}"
  register: api_response
  until: api_response.status == semaphore_api_status_code
  retries: "{{ semaphore_api_retries }}"
  delay: "{{ semaphore_api_retry_delay }}"
  when: semaphore_api_token is defined and semaphore_api_token != ""
  failed_when: false

- name: Make API call with basic authentication
  ansible.builtin.uri:
    url: "{{ final_api_url }}"
    method: GET
    user: "{{ semaphore_api_user }}"
    password: "{{ semaphore_api_password }}"
    force_basic_auth: true
    headers:
      Content-Type: "application/json"
    validate_certs: "{{ semaphore_api_validate_certs }}"
    timeout: "{{ semaphore_api_timeout }}"
    follow_redirects: "{{ semaphore_api_follow_redirects }}"
    return_content: "{{ semaphore_api_return_content }}"
    status_code: "{{ semaphore_api_status_code }}"
  register: api_response
  until: api_response.status == semaphore_api_status_code
  retries: "{{ semaphore_api_retries }}"
  delay: "{{ semaphore_api_retry_delay }}"
  when: semaphore_api_token is not defined or semaphore_api_token == ""
  failed_when: false

- name: Check if API call was successful
  ansible.builtin.assert:
    that:
      - api_response.status is defined
      - api_response.status == semaphore_api_status_code
    fail_msg: |
      API call failed for {{ api_endpoint_name }} endpoint.
      Status: {{ api_response.status | default('N/A') }}
      Message: {{ api_response.msg | default('No error message available') }}
      URL: {{ final_api_url }}
      {% if api_response.json is defined and api_response.json.error is defined %}
      API Error: {{ api_response.json.error }}
      {% endif %}
    success_msg: "Successfully retrieved data from {{ api_endpoint_name }} endpoint"

- name: Validate response is JSON
  ansible.builtin.assert:
    that:
      - api_response.json is defined
    fail_msg: "API response is not valid JSON for {{ api_endpoint_name }} endpoint"
    success_msg: "Response is valid JSON"

- name: Display response summary
  ansible.builtin.debug:
    msg:
      - "Successfully retrieved data from {{ api_endpoint_name }}"
      - "Response type: {{ api_response.json | type_debug }}"
      - "Response size: {% if api_response.json is iterable and api_response.json is not string and api_response.json is not mapping %}{{ api_response.json | length }} items{% else %}1 item{% endif %}"
  when: semaphore_api_debug | bool

- name: Display full response
  ansible.builtin.debug:
    var: api_response.json
  when: semaphore_api_verbose_debug | bool

- name: Set response fact
  ansible.builtin.set_fact:
    "{{ api_response_var }}": "{{ api_response.json }}"
