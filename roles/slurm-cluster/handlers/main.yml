---
# Handlers for slurm-cluster role
#
# Handler execution order is important:
# 1. Munge must restart before Slurm services
# 2. Controller services before compute services (in multi-play scenarios)

- name: Restart munge
  ansible.builtin.systemd:
    name: "{{ slurm_munge_service }}"
    state: restarted
  become: true
  listen: "restart authentication"

- name: Wait for munge after restart
  ansible.builtin.wait_for:
    path: "{{ slurm_munge_run_dir | default('/run/munge') }}/munge.socket.2"
    state: present
    timeout: 30
  become: true
  listen: "restart authentication"

- name: Restart slurmctld
  ansible.builtin.systemd:
    name: "{{ slurm_controller_service }}"
    state: restarted
  become: true
  when: slurm_node_role == 'controller'
  listen: "restart slurm services"

- name: Restart slurmd
  ansible.builtin.systemd:
    name: "{{ slurm_compute_service }}"
    state: restarted
  become: true
  when: slurm_node_role == 'compute'
  listen: "restart slurm services"

- name: Reload slurmctld
  ansible.builtin.systemd:
    name: "{{ slurm_controller_service }}"
    state: reloaded
  become: true
  when: slurm_node_role == 'controller'
  listen: "reload slurm services"

- name: Reload slurmd
  ansible.builtin.systemd:
    name: "{{ slurm_compute_service }}"
    state: reloaded
  become: true
  when: slurm_node_role == 'compute'
  listen: "reload slurm services"

- name: Reconfigure slurm
  ansible.builtin.command: scontrol reconfigure
  become: true
  when: slurm_node_role == 'controller'
  changed_when: true
