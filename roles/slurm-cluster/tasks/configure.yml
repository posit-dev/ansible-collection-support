---
# Configuration tasks for Slurm

- name: Create Slurm configuration directory
  ansible.builtin.file:
    path: /etc/slurm
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Deploy slurm.conf on controller
  ansible.builtin.template:
    src: slurm.conf.j2
    dest: "{{ slurm_conf_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: "slurmctld -t -f %s"
  become: true
  notify:
    - Reconfigure slurm
  when: slurm_node_role == 'controller'

- name: Deploy slurm.conf on compute nodes
  ansible.builtin.template:
    src: slurm.conf.j2
    dest: "{{ slurm_conf_path }}"
    owner: root
    group: root
    mode: "0644"
  become: true
  register: slurm_compute_conf_deployed
  notify:
    - Restart slurmd
  when: slurm_node_role == 'compute'

- name: Validate slurm.conf on compute nodes
  ansible.builtin.command: "grep -q '^ClusterName=' {{ slurm_conf_path }}"
  become: true
  changed_when: false
  failed_when: false
  register: slurm_compute_conf_check
  when:
    - slurm_node_role == 'compute'
    - slurm_compute_conf_deployed is changed

- name: Fail if slurm.conf is invalid on compute node
  ansible.builtin.fail:
    msg: "slurm.conf validation failed on compute node - missing ClusterName directive"
  when:
    - slurm_node_role == 'compute'
    - slurm_compute_conf_check is defined
    - slurm_compute_conf_check.rc is defined
    - slurm_compute_conf_check.rc != 0

- name: Deploy cgroup.conf
  ansible.builtin.template:
    src: cgroup.conf.j2
    dest: "{{ slurm_cgroup_conf_path }}"
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Restart slurmctld
    - Restart slurmd

- name: Deploy cgroup_allowed_devices_file.conf
  ansible.builtin.template:
    src: cgroup_allowed_devices_file.conf.j2
    dest: /etc/slurm/cgroup_allowed_devices_file.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Restart slurmctld
    - Restart slurmd

- name: Deploy logrotate configuration
  ansible.builtin.template:
    src: slurm-logrotate.j2
    dest: /etc/logrotate.d/slurm
    owner: root
    group: root
    mode: "0644"
  become: true
  when: slurm_logrotate_enabled | bool
