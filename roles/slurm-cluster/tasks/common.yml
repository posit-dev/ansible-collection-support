---
# Common setup tasks for all Slurm nodes

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install common Slurm packages
  ansible.builtin.apt:
    name: "{{ slurm_common_packages }}"
    state: present
  become: true

- name: Install cgroup support packages
  ansible.builtin.apt:
    name: "{{ slurm_cgroup_packages }}"
    state: present
  become: true

- name: Install NFS client packages
  ansible.builtin.apt:
    name: "{{ slurm_nfs_packages }}"
    state: present
  become: true
  when: slurm_nfs_server | length > 0

- name: Create Slurm user
  ansible.builtin.user:
    name: slurm
    system: true
    shell: /bin/false
    home: /nonexistent
    create_home: false
    state: present
  become: true

- name: Create Slurm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: slurm
    group: slurm
    mode: "0755"
  loop:
    - "{{ slurm_spool_dir }}"
    - "{{ slurm_log_dir }}"
    - "{{ slurm_pid_dir }}"
  become: true

- name: Create shared storage mount point
  ansible.builtin.file:
    path: "{{ slurm_shared_storage_path }}"
    state: directory
    mode: "0755"
  become: true
  when: slurm_nfs_server | length > 0

- name: Check NFS server availability
  ansible.builtin.wait_for:
    host: "{{ slurm_nfs_server }}"
    port: 2049
    timeout: "{{ slurm_nfs_timeout }}"
    state: started
  when: slurm_nfs_server | length > 0

- name: Mount NFS shared storage
  ansible.posix.mount:
    path: "{{ slurm_shared_storage_path }}"
    src: "{{ slurm_nfs_server }}:{{ slurm_nfs_export }}"
    fstype: nfs4
    opts: "{{ slurm_nfs_mount_options }}"
    state: mounted
  become: true
  when: slurm_nfs_server | length > 0

- name: Ensure Munge directory exists
  ansible.builtin.file:
    path: /etc/munge
    state: directory
    owner: munge
    group: munge
    mode: "0700"
  become: true

- name: Ensure Munge log directory exists
  ansible.builtin.file:
    path: /var/log/munge
    state: directory
    owner: munge
    group: munge
    mode: "0700"
  become: true

- name: Ensure Munge run directory exists
  ansible.builtin.file:
    path: /run/munge
    state: directory
    owner: munge
    group: munge
    mode: "0755"
  become: true

- name: Add controller to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ slurm_controller_ip }} {{ slurm_controller_hostname }}"
    state: present
  become: true
  when: slurm_controller_ip | length > 0

- name: Add compute nodes to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ item.ip | default('') }} {{ item.name }}"
    state: present
  loop: "{{ slurm_compute_nodes }}"
  become: true
  when: item.ip is defined and item.ip | length > 0

# Firewall configuration (optional)
- name: Install UFW firewall package
  ansible.builtin.apt:
    name: ufw
    state: present
  become: true
  when: slurm_configure_firewall | bool

- name: Allow Munge traffic (all nodes)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Slurm Munge authentication"
  loop:
    - "{{ slurm_slurmctld_port }}"
    - "{{ slurm_slurmd_port }}"
  become: true
  when: slurm_configure_firewall | bool

- name: Allow slurmctld port on controller
  community.general.ufw:
    rule: allow
    port: "{{ slurm_slurmctld_port }}"
    proto: tcp
    comment: "Slurm controller daemon"
  become: true
  when:
    - slurm_configure_firewall | bool
    - slurm_node_role == 'controller'

- name: Allow slurmd port on compute nodes
  community.general.ufw:
    rule: allow
    port: "{{ slurm_slurmd_port }}"
    proto: tcp
    comment: "Slurm compute daemon"
  become: true
  when:
    - slurm_configure_firewall | bool
    - slurm_node_role == 'compute'
