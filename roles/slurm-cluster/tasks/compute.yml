---
# Compute node (slurmd) specific tasks

- name: Install compute node packages
  ansible.builtin.apt:
    name: "{{ slurm_compute_packages }}"
    state: present
  become: true
  register: slurm_compute_install
  retries: "{{ slurm_package_install_retries }}"
  delay: "{{ slurm_package_install_retry_delay }}"
  until: slurm_compute_install is success

- name: Create slurmd spool directory
  ansible.builtin.file:
    path: "{{ slurm_spool_dir }}/slurmd"
    state: directory
    owner: slurm
    group: slurm
    mode: "0755"
  become: true

- name: Validate Munge key availability
  ansible.builtin.assert:
    that:
      - slurm_munge_key | length > 0 or hostvars['localhost']['slurm_cluster_munge_key'] is defined
    fail_msg: >
      No Munge key available. Either provide 'slurm_munge_key' variable or
      ensure the controller node was configured first (it generates and stores the key).
      Run the playbook with controller nodes before compute nodes, or use a shared key.
    success_msg: "Munge key source validated"

- name: Retrieve Munge key from controller
  ansible.builtin.set_fact:
    slurm_actual_munge_key: "{{ hostvars['localhost']['slurm_cluster_munge_key'] }}"
  no_log: true
  when: slurm_munge_key | length == 0

- name: Set Munge key if provided
  ansible.builtin.set_fact:
    slurm_actual_munge_key: "{{ slurm_munge_key }}"
  no_log: true
  when: slurm_munge_key | length > 0

- name: Deploy Munge key
  ansible.builtin.copy:
    content: "{{ slurm_actual_munge_key | b64decode }}"
    dest: "{{ slurm_munge_dir }}/munge.key"
    owner: munge
    group: munge
    mode: "0400"
  become: true
  notify: Restart munge
  no_log: true

- name: Flush handlers to ensure Munge restarts before verification
  ansible.builtin.meta: flush_handlers

- name: Enable and start Munge service
  ansible.builtin.systemd:
    name: munge
    enabled: true
    state: started
  become: true

- name: Wait for Munge service to be ready
  ansible.builtin.wait_for:
    path: "{{ slurm_munge_run_dir }}/munge.socket.2"
    state: present
    timeout: 30
  become: true

- name: Verify Munge service is running
  ansible.builtin.command: systemctl is-active munge
  register: slurm_munge_status
  changed_when: false
  failed_when: slurm_munge_status.rc != 0

- name: Test Munge authentication
  ansible.builtin.command: munge -n
  register: slurm_munge_test
  changed_when: false
  failed_when: slurm_munge_test.rc != 0
  become: true
  become_user: munge

- name: Create Slurm configuration directory
  ansible.builtin.file:
    path: /etc/slurm
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Configure cgroups for Slurm
  ansible.builtin.template:
    src: cgroup.conf.j2
    dest: /etc/slurm/cgroup.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart slurmd
