---
# tasks/setup.yml - Setup semaphore container and configure

# ==============================================
# Encryption Key Management
# ==============================================

- name: Generate encryption key if not provided
  ansible.builtin.set_fact:
    _semaphore_encryption_key: "{{ semaphore_access_key_encryption | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits'), true) }}"
    cacheable: true
  when: semaphore_access_key_encryption | length == 0
  no_log: true
  tags:
    - semaphore
    - semaphore_setup

- name: Use provided encryption key
  ansible.builtin.set_fact:
    _semaphore_encryption_key: "{{ semaphore_access_key_encryption }}"
  when: semaphore_access_key_encryption | length > 0
  no_log: true
  tags:
    - semaphore
    - semaphore_setup

# ==============================================
# Container Setup
# ==============================================

- name: Create semaphore data volume
  containers.podman.podman_volume:
    name: "{{ semaphore_volume_name }}"
    state: present
  tags:
    - semaphore
    - semaphore_setup

- name: Determine git volume path
  ansible.builtin.set_fact:
    _semaphore_git_volume: "{{ semaphore_git_volume | default(playbook_dir, true) }}"
  tags:
    - semaphore
    - semaphore_setup

- name: Create semaphore container
  containers.podman.podman_container:
    name: "{{ semaphore_container_name }}"
    image: "{{ semaphore_image }}"
    state: started
    restart_policy: "{{ semaphore_restart_policy }}"
    ports:
      - "{{ semaphore_host_port }}:{{ semaphore_port }}"
    volumes:
      - "{{ semaphore_volume_name }}:{{ _semaphore_data_path }}:Z"
      - "{{ _semaphore_git_volume }}:{{ _semaphore_git_mount }}"
    env:
      SEMAPHORE_DB_DIALECT: "{{ _semaphore_db_dialect }}"
      SEMAPHORE_ADMIN: "{{ semaphore_admin_user }}"
      SEMAPHORE_ADMIN_PASSWORD: "{{ semaphore_admin_password }}"
      SEMAPHORE_ADMIN_EMAIL: "{{ semaphore_admin_email }}"
      SEMAPHORE_ADMIN_NAME: "{{ semaphore_admin_name }}"
      SEMAPHORE_ACCESS_KEY_ENCRYPTION: "{{ _semaphore_encryption_key }}"
  register: container_result
  no_log: true
  tags:
    - semaphore
    - semaphore_setup

# ==============================================
# API Availability Check
# ==============================================

- name: Wait for Semaphore API to become available
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Check API health
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.ping }}"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
      register: api_health
      until: api_health.status in _semaphore_success_codes
      retries: "{{ (semaphore_wait_timeout / semaphore_wait_delay) | int }}"
      delay: "{{ semaphore_wait_delay }}"
  rescue:
    - name: API health check failed - get container logs
      ansible.builtin.command:
        cmd: "podman logs --tail 50 {{ semaphore_container_name }}"
      register: container_logs
      changed_when: false
      failed_when: false

    - name: Display troubleshooting information
      ansible.builtin.fail:
        msg: |
          ERROR: Semaphore API failed to become available within {{ semaphore_wait_timeout }} seconds.

          Troubleshooting:
            - URL attempted: {{ semaphore_api_url }}{{ _semaphore_endpoints.ping }}
            - Container: {{ semaphore_container_name }}

          Recent container logs:
          {{ container_logs.stdout | default('No logs available') }}

          Possible causes:
            - Container failed to start properly
            - Port {{ semaphore_host_port }} is already in use
            - Database initialization failed

# ==============================================
# Authentication
# ==============================================

- name: Authenticate to Semaphore API
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Authenticate and get session cookie
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.login }}"
        method: POST
        body_format: json
        body:
          auth: "{{ semaphore_admin_user }}"
          password: "{{ semaphore_admin_password }}"
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
      register: auth_response
      no_log: true
      retries: "{{ semaphore_api_retries }}"
      delay: "{{ semaphore_api_retry_delay }}"
      until: auth_response.status in _semaphore_success_codes

    - name: Extract session cookie
      ansible.builtin.set_fact:
        _semaphore_session_cookie: "{{ auth_response.cookies_string }}"
      no_log: true

    - name: Create API token
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.tokens }}"
        method: POST
        body_format: json
        body: {}
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Cookie: "{{ _semaphore_session_cookie }}"
      register: token_response
      no_log: true
      retries: "{{ semaphore_api_retries }}"
      delay: "{{ semaphore_api_retry_delay }}"
      until: token_response.status in _semaphore_success_codes

    - name: Set API token fact
      ansible.builtin.set_fact:
        _semaphore_api_token: "{{ token_response.json.id }}"
      no_log: true

    - name: Save API token to vault file
      when: semaphore_save_api_token | bool
      block:
        - name: Build vault password file argument
          ansible.builtin.set_fact:
            _vault_pass_arg: "{{ '--vault-password-file ' + semaphore_vault_password_file if semaphore_vault_password_file | length > 0 else '' }}"

        - name: Decrypt vault file
          ansible.builtin.command:
            cmd: "ansible-vault decrypt {{ _vault_pass_arg }} {{ semaphore_api_token_vault_file }}"
          delegate_to: localhost
          no_log: true
          changed_when: true

        - name: Read decrypted vault file
          ansible.builtin.slurp:
            src: "{{ semaphore_api_token_vault_file }}"
          register: _vault_content
          delegate_to: localhost
          no_log: true

        - name: Parse vault content
          ansible.builtin.set_fact:
            _vault_data: "{{ _vault_content.content | b64decode | from_yaml }}"
          no_log: true

        - name: Update vault data with new token
          ansible.builtin.set_fact:
            _vault_data_updated: "{{ _vault_data | combine({'semaphore_api_token': _semaphore_api_token}) }}"
          no_log: true

        - name: Write updated vault file
          ansible.builtin.copy:
            content: "{{ _vault_data_updated | to_nice_yaml }}"
            dest: "{{ semaphore_api_token_vault_file }}"
            mode: '0600'
          delegate_to: localhost
          no_log: true

        - name: Re-encrypt vault file
          ansible.builtin.command:
            cmd: "ansible-vault encrypt {{ _vault_pass_arg }} {{ semaphore_api_token_vault_file }}"
          delegate_to: localhost
          no_log: true
          changed_when: true
  rescue:
    - name: Authentication failed
      ansible.builtin.fail:
        msg: |
          ERROR: Failed to authenticate to Semaphore API.

          Possible causes:
            - Invalid admin credentials
            - API is not fully initialized
            - Network connectivity issues

          Admin user: {{ semaphore_admin_user }}
          API URL: {{ semaphore_api_url }}

# ==============================================
# Project Setup (Optional)
# ==============================================

- name: Setup project
  when: semaphore_create_project | bool
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Check if project already exists
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.projects }}"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: existing_projects

    - name: Find existing project by name
      ansible.builtin.set_fact:
        _existing_project_list: "{{ existing_projects.json | selectattr('name', 'equalto', semaphore_project_name) | list }}"

    - name: Create project if it does not exist
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.projects }}"
        method: POST
        body_format: json
        body:
          name: "{{ semaphore_project_name }}"
          alert: false
          alert_chat: ""
          max_parallel_tasks: 0
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: new_project_response
      when: _existing_project_list | length == 0

    - name: Set project ID fact
      ansible.builtin.set_fact:
        _semaphore_project_id: "{{ _existing_project_list[0].id if _existing_project_list | length > 0 else new_project_response.json.id }}"
        _semaphore_project_created: "{{ _existing_project_list | length == 0 }}"

# ==============================================
# Empty Key Setup (Required for inventory/repository)
# ==============================================

- name: Setup empty key for inventory and repository
  when:
    - semaphore_create_project | bool
    - (semaphore_create_inventory | bool) or (semaphore_create_repository | bool)
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Check if empty key already exists
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/keys"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: existing_keys

    - name: Find existing empty key by name
      ansible.builtin.set_fact:
        _existing_empty_key_list: "{{ existing_keys.json | selectattr('name', 'equalto', 'None') | list }}"

    - name: Build empty key request body
      ansible.builtin.set_fact:
        _empty_key_body: >-
          {{
            {
              "name": "None",
              "type": "none",
              "project_id": _semaphore_project_id | int
            }
          }}
      when: _existing_empty_key_list | length == 0

    - name: Create empty key if it does not exist
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/keys"
        method: POST
        body_format: json
        body: "{{ _empty_key_body }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
        status_code: "{{ _semaphore_success_codes }}"
      register: new_empty_key_response
      when: _existing_empty_key_list | length == 0

    - name: Set empty key ID fact
      ansible.builtin.set_fact:
        _semaphore_empty_key_id: "{{ _existing_empty_key_list[0].id if _existing_empty_key_list | length > 0 else new_empty_key_response.json.id }}"

# ==============================================
# Inventory Setup (Optional)
# ==============================================

- name: Setup inventory
  when:
    - semaphore_create_inventory | bool
    - semaphore_create_project | bool
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Check if inventory already exists
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/inventory"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: existing_inventories

    - name: Find existing inventory by name
      ansible.builtin.set_fact:
        _existing_inventory_list: "{{ existing_inventories.json | selectattr('name', 'equalto', semaphore_inventory_name) | list }}"

    - name: Build inventory request body
      ansible.builtin.set_fact:
        _inventory_body: >-
          {{
            {
              "name": semaphore_inventory_name,
              "project_id": _semaphore_project_id | int,
              "inventory": semaphore_inventory_content | trim,
              "type": "static",
              "ssh_key_id": _semaphore_empty_key_id | int,
              "become_key_id": _semaphore_empty_key_id | int
            }
          }}
      when: _existing_inventory_list | length == 0

    - name: Create inventory if it does not exist
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/inventory"
        method: POST
        body_format: json
        body: "{{ _inventory_body }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
        status_code: "{{ _semaphore_success_codes }}"
      register: new_inventory_response
      when: _existing_inventory_list | length == 0

    - name: Set inventory ID fact
      ansible.builtin.set_fact:
        _semaphore_inventory_id: "{{ _existing_inventory_list[0].id if _existing_inventory_list | length > 0 else new_inventory_response.json.id }}"
        _semaphore_inventory_created: "{{ _existing_inventory_list | length == 0 }}"

# ==============================================
# Repository Setup (Optional)
# ==============================================

- name: Setup repository
  when:
    - semaphore_create_repository | bool
    - semaphore_create_project | bool
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Check if repository already exists
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/repositories"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: existing_repositories

    - name: Find existing repository by name
      ansible.builtin.set_fact:
        _existing_repository_list: "{{ existing_repositories.json | selectattr('name', 'equalto', semaphore_repository_name) | list }}"

    - name: Build repository request body
      ansible.builtin.set_fact:
        _repository_body: >-
          {{
            {
              "name": semaphore_repository_name,
              "git_url": semaphore_repository_path,
              "project_id": _semaphore_project_id | int,
              "git_branch": "",
              "ssh_key_id": _semaphore_empty_key_id | int
            }
          }}
      when: _existing_repository_list | length == 0

    - name: Create repository if it does not exist
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}/project/{{ _semaphore_project_id }}/repositories"
        method: POST
        body_format: json
        body: "{{ _repository_body }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
        status_code: "{{ _semaphore_success_codes }}"
      register: new_repository_response
      when: _existing_repository_list | length == 0

    - name: Set repository ID fact
      ansible.builtin.set_fact:
        _semaphore_repository_id: "{{ _existing_repository_list[0].id if _existing_repository_list | length > 0 else new_repository_response.json.id }}"
        _semaphore_repository_created: "{{ _existing_repository_list | length == 0 }}"

# ==============================================
# Additional Users (Optional)
# ==============================================

- name: Create additional users
  when: semaphore_additional_users | length > 0
  tags:
    - semaphore
    - semaphore_setup
  block:
    - name: Get existing users
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.users }}"
        method: GET
        status_code: "{{ _semaphore_success_codes }}"
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
      register: existing_users

    - name: Create each additional user if not exists
      ansible.builtin.uri:
        url: "{{ semaphore_api_url }}{{ _semaphore_endpoints.users }}"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          username: "{{ item.username }}"
          email: "{{ item.email }}"
          password: "{{ item.password }}"
          alert: "{{ item.alert | default(true) }}"
          admin: "{{ item.admin | default(false) }}"
          external: false
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{ _semaphore_api_token }}"
        status_code: "{{ _semaphore_success_codes }}"
      loop: "{{ semaphore_additional_users }}"
      loop_control:
        label: "{{ item.username }}"
      when: item.username not in (existing_users.json | map(attribute='username') | list)
      no_log: true
      register: user_creation_results

# ==============================================
# Summary
# ==============================================

- name: Display setup summary
  ansible.builtin.debug:
    msg:
      - "Semaphore UI setup completed successfully!"
      - ""
      - "Access URL: http://{{ semaphore_api_host }}:{{ semaphore_host_port }}"
      - "Admin User: {{ semaphore_admin_user }}"
      - ""
      - "Project: {{ semaphore_project_name }} (ID: {{ _semaphore_project_id | default('N/A') }}){{ ' [created]' if (_semaphore_project_created | default(false)) else ' [existing]' }}"
      - "Inventory: {{ semaphore_inventory_name }} (ID: {{ _semaphore_inventory_id | default('N/A') }}){{ ' [created]' if (_semaphore_inventory_created | default(false)) else ' [existing]' }}"
      - "Repository: {{ semaphore_repository_name }} (ID: {{ _semaphore_repository_id | default('N/A') }}){{ ' [created]' if (_semaphore_repository_created | default(false)) else ' [existing]' }}"
      - ""
      - "Additional users configured: {{ semaphore_additional_users | length }}"
      - ""
      - "API Token: {{ 'Saved to vault ' + semaphore_api_token_vault_file if (semaphore_save_api_token | bool) else 'Not saved (set semaphore_save_api_token=true to persist)' }}"
  when: semaphore_create_project | bool
  tags:
    - semaphore
    - semaphore_setup

- name: Display minimal setup summary
  ansible.builtin.debug:
    msg:
      - "Semaphore UI container started successfully!"
      - ""
      - "Access URL: http://{{ semaphore_api_host }}:{{ semaphore_host_port }}"
      - "Admin User: {{ semaphore_admin_user }}"
      - ""
      - "No project/inventory/repository created (disabled in configuration)"
  when: not (semaphore_create_project | bool)
  tags:
    - semaphore
    - semaphore_setup
